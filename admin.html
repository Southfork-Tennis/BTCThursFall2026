<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Berwick Tennis Club — Admin</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
/* SAME STYLING AS INDEX */
:root{
  --bg:#070b16;
  --card:rgba(18,26,51,.78);
  --muted:#93a4c7;
  --text:#e9eeff;
  --accent:#7dd3fc;
  --good:#34d399;
  --warn:#fbbf24;
  --bad:#fb7185;
  --border:rgba(255,255,255,.10);
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --radius:16px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:var(--bg);
  color:var(--text);
}
header{
  background:#0c1530;
  padding:16px;
  border-bottom:1px solid var(--border);
}
.wrap{max-width:1100px;margin:auto;padding:20px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
  margin-bottom:16px;
}
input,select{
  background:#0c1530;
  border:1px solid var(--border);
  color:var(--text);
  padding:8px;
  border-radius:8px;
}
button{
  padding:8px 14px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#1b2b55;
  color:white;
  cursor:pointer;
}
button.primary{background:#2563eb}
button.danger{background:#dc2626}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table td,.table th{padding:8px;border-bottom:1px solid var(--border);text-align:center}
.badge{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
.badge.good{color:var(--good)}
.badge.bad{color:var(--bad)}
.badge.warn{color:var(--warn)}
.hidden{display:none}
</style>
</head>

<body>

<header>
  <div class="wrap">
    <h2>Berwick Tennis Club — Admin Panel</h2>
    <div style="color:var(--muted)">Thursday Night Competition</div>
  </div>
</header>

<div class="wrap">

<!-- LOGIN -->
<div class="card" id="loginCard">
  <h3>Enter Admin Code</h3>
  <div class="row">
    <input type="password" id="adminCode" placeholder="Enter code" />
    <button onclick="unlock()">Unlock</button>
  </div>
</div>

<!-- ADMIN CONTENT -->
<div id="adminContent" class="hidden">

  <!-- Upload Scores -->
  <div class="card">
    <h3>Upload Scores</h3>

    <div class="row">
      <label>Round:</label>
      <select id="roundSelect"></select>

      <label>Match:</label>
      <select id="matchSelect"></select>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th>Pairing</th>
          <th>Team A</th>
          <th>Team B</th>
        </tr>
      </thead>
      <tbody id="scoreBody"></tbody>
    </table>

    <div class="row" style="margin-top:15px">
      <button class="primary" onclick="saveMatch()">Save Match</button>
      <button onclick="clearMatch()">Clear Match</button>
      <button class="danger" onclick="resetAll()">Reset All</button>
    </div>
  </div>

</div>

</div>

<script>

/* CONFIG */
const SHEETS_WEBAPP_URL =
"https://script.google.com/macros/s/AKfycbw8GVO1VqmhHyNhgoVr25lvkROu0D0lrqDA0RQqNQ0e3nxs8ZpJl_uXJe0XIvJjt-H1BQ/exec";

const WRITE_KEY = "BTC1818";

/* TEAMS + ROUNDS (same structure as index) */
const teams = {
  1:["Cooper Khalil","Simran Chawla","David Sutton","Chris Maniatakis"],
  2:["Enrique Lopez","Craig Kitner","Josh Bury","Varun Sridhara"],
  3:["Michael Rominger","David Ng","Cameron Rush","Alan Chumacero"],
  4:["Jonathan Rogers","Rafa Bouzinelos","David Thurmond","Andrew Watson"],
  5:["Chung Tan","Huss Shafai","Tom Maloney","Brett Kurz"],
  6:["Vignesh Pakkiam","Eric Castricum","Stephen Saunders","Mark Findlay"],
  7:["Chris Scott","Justin Hermann","Nick Teo","Dishit Devasia"],
};

const rounds = [
  {r:1, matches:[[1,6],[2,5],[3,4],[7,null]]},
  {r:2, matches:[[4,2],[5,1],[6,7],[3,null]]},
  {r:3, matches:[[2,7],[3,6],[4,5],[1,null]]},
  {r:4, matches:[[5,3],[6,2],[7,1],[4,null]]},
  {r:5, matches:[[3,1],[4,7],[5,6],[2,null]]},
  {r:6, matches:[[6,4],[7,3],[1,2],[5,null]]},
  {r:7, matches:[[7,5],[1,4],[2,3],[6,null]]},
  {r:8, matches:[[1,6],[2,5],[3,4],[7,null]]},
  {r:9, matches:[[4,2],[5,1],[6,7],[3,null]]},
  {r:10, matches:[[2,7],[3,6],[4,5],[1,null]]},
  {r:11, matches:[[5,3],[6,2],[7,1],[4,null]]},
  {r:12, matches:[[3,1],[4,7],[5,6],[2,null]]},
  {r:13, matches:[[6,4],[7,3],[1,2],[5,null]]},
  {r:14, matches:[[7,5],[1,4],[2,3],[6,null]]}
];

const pairings = [
  {key:"12", label:"1+2"},
  {key:"34", label:"3+4"},
  {key:"13", label:"1+3"},
  {key:"24", label:"2+4"},
  {key:"14", label:"1+4"},
  {key:"23", label:"2+3"},
];

let unlocked = false;

/* LOGIN */
function unlock(){
  if(document.getElementById("adminCode").value === WRITE_KEY){
    unlocked = true;
    document.getElementById("loginCard").style.display="none";
    document.getElementById("adminContent").classList.remove("hidden");
    initAdmin();
  } else {
    alert("Wrong code");
  }
}

/* INIT */
function initAdmin(){
  const rs = document.getElementById("roundSelect");
  rounds.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r.r;
    opt.textContent = "Round " + r.r;
    rs.appendChild(opt);
  });

  rs.onchange = updateMatchSelect;
  updateMatchSelect();
}

/* MATCH SELECT */
function updateMatchSelect(){
  const r = Number(document.getElementById("roundSelect").value);
  const round = rounds.find(x=>x.r===r);

  const ms = document.getElementById("matchSelect");
  ms.innerHTML="";
  round.matches.forEach((m,i)=>{
    if(m[1]==null) return;
    const opt=document.createElement("option");
    opt.value=i;
    opt.textContent=`Match ${i+1} (${m[0]} vs ${m[1]})`;
    ms.appendChild(opt);
  });

  ms.onchange = renderScoreSheet;
  renderScoreSheet();
}

/* SCORE ENTRY */
function renderScoreSheet(){
  const r = Number(document.getElementById("roundSelect").value);
  const mIndex = Number(document.getElementById("matchSelect").value);
  const match = rounds.find(x=>x.r===r).matches[mIndex];

  const body=document.getElementById("scoreBody");
  body.innerHTML="";

  pairings.forEach(p=>{
    body.innerHTML += `
      <tr>
        <td>${p.label}</td>
        <td><input type="number" min="0" max="7" data-pair="${p.key}" data-side="a"></td>
        <td><input type="number" min="0" max="7" data-pair="${p.key}" data-side="b"></td>
      </tr>
    `;
  });
}

/* SAVE */
async function saveMatch(){
  const r = Number(document.getElementById("roundSelect").value);
  const mIndex = Number(document.getElementById("matchSelect").value);
  const match = rounds.find(x=>x.r===r).matches[mIndex];
  const [a,b]=match;

  const inputs=document.querySelectorAll("input[data-pair]");
  const pairs={};
  let aSets=0,bSets=0,aGamesTotal=0,bGamesTotal=0;

  pairings.forEach(p=>{
    const aG = Number(document.querySelector(`input[data-pair="${p.key}"][data-side="a"]`).value||0);
    const bG = Number(document.querySelector(`input[data-pair="${p.key}"][data-side="b"]`).value||0);

    pairs[p.key]={a:aG,b:bG};
    aGamesTotal+=aG;
    bGamesTotal+=bG;

    if(aG>bG) aSets++;
    else if(bG>aG) bSets++;
  });

  let aPts=aSets,bPts=bSets;
  if(aSets>bSets) aPts+=2;
  else if(bSets>aSets) bPts+=2;

  const record={
    a,b,
    aSets,bSets,
    aPts,bPts,
    aGamesTotal,bGamesTotal,
    pairs,
    ts:Date.now()
  };

  const url=new URL(SHEETS_WEBAPP_URL);
  url.searchParams.set("action","upsert");
  url.searchParams.set("key",WRITE_KEY);
  url.searchParams.set("matchKey",`r${r}_m${mIndex}`);
  url.searchParams.set("record",JSON.stringify(record));

  const res=await fetch(url.toString());
  const json=await res.json();
  alert(json.ok?"Saved":"Error: "+json.error);
}

/* CLEAR */
async function clearMatch(){
  const r = Number(document.getElementById("roundSelect").value);
  const mIndex = Number(document.getElementById("matchSelect").value);

  const url=new URL(SHEETS_WEBAPP_URL);
  url.searchParams.set("action","delete");
  url.searchParams.set("key",WRITE_KEY);
  url.searchParams.set("matchKey",`r${r}_m${mIndex}`);

  const res=await fetch(url.toString());
  const json=await res.json();
  alert(json.ok?"Deleted":"Error: "+json.error);
}

/* RESET */
async function resetAll(){
  if(!confirm("Reset entire season?")) return;

  const url=new URL(SHEETS_WEBAPP_URL);
  url.searchParams.set("action","reset");
  url.searchParams.set("key",WRITE_KEY);

  const res=await fetch(url.toString());
  const json=await res.json();
  alert(json.ok?"All reset":"Error: "+json.error);
}

</script>
</body>
</html>
