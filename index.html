<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Berwick Tennis Club ‚Äî Thursday Night Comp (Autumn 2026)</title>
  <style>
    :root{
      --bg:#070b16;
      --card:rgba(18,26,51,.78);
      --muted:#93a4c7;
      --text:#e9eeff;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --border:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(125,211,252,.20), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(167,139,250,.18), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0;
      backdrop-filter: blur(10px);
      background: rgba(7,11,22,.78);
      border-bottom:1px solid var(--border);
      z-index:10
    }
    .wrap{max-width:1150px; margin:0 auto; padding:18px 18px}
    .top{display:flex; align-items:center; gap:14px; justify-content:space-between; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:12px}
    h1{font-size:18px; margin:0}
    .sub{font-size:12px; color:var(--muted); margin-top:2px}

    nav{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      border:1px solid var(--border);
      background: rgba(18,26,51,.65);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
    }
    .tab[aria-selected="true"]{
      border-color: rgba(125,211,252,.55);
      background: rgba(125,211,252,.12)
    }

    main{padding:18px 0 60px}
    .grid{display:grid; gap:14px}
    .grid.two{grid-template-columns: 1.15fr .85fr}
    @media (max-width: 900px){.grid.two{grid-template-columns:1fr}}

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow)
    }
    .card .hd{padding:14px 14px 0}
    .card .bd{padding:14px}
    .title{font-size:16px; margin:0 0 6px}
    .muted{color:var(--muted)}
    .foot{margin-top:10px; font-size:12px; color:var(--muted)}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border);
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted)
    }
    .dot{width:8px; height:8px; border-radius:50%; background:var(--accent)}

    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px}
    th,td{padding:10px 10px; border-bottom:1px solid var(--border); text-align:left; font-size:13px; vertical-align:top}
    th{font-size:12px; color:var(--muted); font-weight:600}
    tr:hover td{background: rgba(255,255,255,.03)}
    .right{text-align:right}
    .center{text-align:center}

    .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    @media (max-width: 760px){.kpi{grid-template-columns:repeat(2,1fr)}}
    .k{padding:12px; border:1px solid var(--border); border-radius:14px; background: rgba(255,255,255,.03)}
    .k .n{font-size:20px; font-weight:800}
    .k .l{font-size:12px; color:var(--muted)}

    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px
    }
    .btn.primary{border-color: rgba(125,211,252,.55); background: rgba(125,211,252,.14)}
    .btn.danger{border-color: rgba(251,113,133,.55); background: rgba(251,113,133,.10)}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    select,input{
      background: rgba(7,11,22,.65);
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      outline:none
    }
    input[type="number"]{width:86px}
    .hint{font-size:12px; color:var(--muted)}

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--border);
      color:var(--muted)
    }
    .badge.good{border-color: rgba(52,211,153,.45); color: rgba(52,211,153,.95)}
    .badge.warn{border-color: rgba(251,191,36,.45); color: rgba(251,191,36,.95)}
    .badge.bad{border-color: rgba(251,113,133,.45); color: rgba(251,113,133,.95)}

    /* Crest */
    .crestWrap{
      width:46px; height:46px; border-radius:14px;
      display:grid; place-items:center;
      box-shadow: var(--shadow);
      background: rgba(18,26,51,.65);
      border:1px solid var(--border);
    }

    /* Team chip popover */
    .team-chip{
      position:relative;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      cursor:pointer;
      font: inherit;
      line-height: 1.2;
      user-select:none;
      white-space: nowrap;
    }
    .team-chip:hover{border-color: rgba(125,211,252,.45)}
    .team-pop{
      position:absolute;
      top: calc(100% + 8px);
      left: 0;
      min-width: 260px;
      background: rgba(18,26,51,.98);
      border:1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding:10px 10px;
      display:none;
      z-index: 50;
    }
    .team-chip:hover .team-pop{display:block}
    .team-chip[data-open="true"] .team-pop{display:block}
    .team-pop .hdr{
      display:flex; justify-content:space-between; align-items:center;
      padding-bottom:8px; margin-bottom:8px; border-bottom:1px solid var(--border);
    }
    .team-pop .hdr b{font-size:13px}
    .team-pop .closex{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius: 10px;
      padding:4px 8px;
      cursor:pointer;
      font-size:12px;
      display:none;
    }
    .team-pop .p{
      display:flex; justify-content:space-between; gap:10px;
      padding:5px 4px;
      border-radius: 10px;
    }
    .team-pop .p:hover{background: rgba(255,255,255,.03)}
    .team-pop .rank{color: var(--muted); font-size:12px}
    .team-pop .name{font-size:13px}

    @media (max-width: 760px){
      .team-chip:hover .team-pop{display:none}
      .team-pop{
        position:fixed;
        left:50%;
        transform:translateX(-50%);
        top:16%;
        width:min(560px, 94vw)
      }
      .team-pop .closex{display:inline-flex}
      input[type="number"]{width:78px}
    }

    /* Scoresheet */
    .sheet{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background: rgba(255,255,255,.02);
    }
    .sheet .head{
      padding:12px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .sheet .meta{display:flex; flex-direction:column; gap:4px}
    .sheet .meta .line{font-size:12px; color:var(--muted)}
    .sheet .teams{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      width:100%;
      margin-top:8px;
    }
    @media (max-width:760px){ .sheet .teams{grid-template-columns:1fr} }

    .teamBox{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background: rgba(255,255,255,.02);
    }
    .teamBox .tname{font-weight:800}
    .teamBox .plist{margin-top:8px; display:grid; gap:6px}
    .teamBox .prow{display:flex; justify-content:space-between; gap:10px}
    .teamBox .prow .r{color:var(--muted); font-size:12px}

    .gridRow{
      display:grid;
      grid-template-columns: 110px 1fr 1fr 90px;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      align-items:center;
    }
    .gridRow:last-child{border-bottom:none}
    .pairTag{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--border);
      padding:6px 8px;
      border-radius:999px;
      width:max-content;
      background: rgba(255,255,255,.02);
    }
    .cell{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .cell .who{font-size:12px; color:var(--muted)}
    .winMark{
      font-size:12px; padding:4px 8px;
      border-radius:999px; border:1px solid var(--border); color:var(--muted)
    }
    .winMark.good{border-color: rgba(52,211,153,.45); color: rgba(52,211,153,.95)}
    .winMark.bad{border-color: rgba(251,113,133,.55); color: rgba(251,113,133,.95)}
    .winMark.warn{border-color: rgba(251,191,36,.45); color: rgba(251,191,36,.95)}
    @media (max-width:760px){
      .gridRow{grid-template-columns: 1fr; gap:8px}
      .gridRow .rightish{justify-content:flex-start}
    }

    .totals{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    @media (max-width:760px){ .totals{grid-template-columns:1fr} }
    .tot{border:1px solid var(--border); border-radius:14px; padding:10px; background: rgba(255,255,255,.02)}
    .tot .k{font-size:12px; color:var(--muted)}
    .tot .v{font-size:18px; font-weight:900; margin-top:4px}

    .gateBox{
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      background: rgba(255,255,255,.02);
      max-width: 520px;
    }

    dialog{
      border:none; border-radius:18px; padding:0;
      background: rgba(18,26,51,.98);
      color:var(--text);
      width:min(520px, 92vw);
      box-shadow: var(--shadow)
    }
    dialog::backdrop{background: rgba(0,0,0,.55)}
    .modal-hd{padding:14px 14px 0}
    .modal-ft{padding:0 14px 14px; display:flex; justify-content:flex-end; gap:10px}

    .bracket{display:grid; grid-template-columns:1fr; gap:12px;}
    .stage{border:1px solid var(--border); border-radius:14px; background: rgba(255,255,255,.02); padding:12px;}
    .stage .subline{margin-top:6px; font-size:12px; color:var(--muted);}
    .stage .match{margin-top:6px; font-size:14px; font-weight:800;}

    @media print{
      header{position:static; background:#fff; color:#000; border:none}
      body{background:#fff; color:#000}
      .card{box-shadow:none; background:#fff; border:1px solid #ccc}
      .tab, .btn, .pill{display:none}
      a{color:#000}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap top">
    <div class="brand">
      <div class="crestWrap" aria-hidden="true" title="Berwick Tennis Club ‚Ä¢ Est. 1948">
        <svg viewBox="0 0 200 200" width="38" height="38" aria-hidden="true">
          <circle cx="100" cy="100" r="92" fill="none" stroke="#ffffff" stroke-width="6"/>
          <circle cx="100" cy="100" r="78" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="2"/>
          <path d="M70 135 L135 70" stroke="#ffffff" stroke-width="7" stroke-linecap="round"/>
          <path d="M70 70 L135 135" stroke="#ffffff" stroke-width="7" stroke-linecap="round"/>
          <circle cx="100" cy="100" r="14" fill="#ffffff"/>
          <text x="100" y="38" text-anchor="middle" fill="#ffffff" font-size="20" font-weight="800">TENNIS</text>
          <text x="100" y="168" text-anchor="middle" fill="#ffffff" font-size="16" font-weight="700">EST. 1948</text>
        </svg>
      </div>
      <div>
        <h1>Berwick Tennis Club ‚Äî Thursday Night Comp</h1>
        <div class="sub">Autumn 2026 ‚Ä¢ 7 teams ‚Ä¢ 14 rounds ‚Ä¢ Navy & White</div>
      </div>
    </div>
    <nav aria-label="Sections">
      <button class="tab" data-view="home" aria-selected="true">Home</button>
      <button class="tab" data-view="teams">Teams</button>
      <button class="tab" data-view="fixtures">Fixtures</button>
      <button class="tab" data-view="results" id="tab-results">Upload Scores üîí</button>
      <button class="tab" data-view="ladder">Ladder</button>
      <button class="tab" data-view="finals">Finals</button>
      <button class="tab" data-view="players">Player Stats</button>
      <button class="tab" data-view="rules">Rules</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- HOME -->
  <section id="view-home" class="view">
    <div class="grid two">
      <div class="card">
        <div class="hd">
          <div class="row" style="justify-content:space-between">
            <h2 class="title">Next Round</h2>
            <span class="pill"><span class="dot"></span><span id="nextRoundPill">Loading‚Ä¶</span></span>
          </div>
          <div class="muted" id="nextRoundDate" style="margin-top:4px"></div>
        </div>
        <div class="bd">
          <div id="nextRoundMatches"></div>
          <div class="foot">Results are stored in Google Sheets (shared). If Sheets is unavailable, the site will show an error when saving/loading.</div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><h2 class="title">Quick Stats</h2><div class="muted">Auto-updates from the shared results sheet</div></div>
        <div class="bd">
          <div class="kpi">
            <div class="k"><div class="n" id="kpiRoundsDone">0</div><div class="l">Rounds completed</div></div>
            <div class="k"><div class="n" id="kpiMatchesDone">0</div><div class="l">Matches recorded</div></div>
            <div class="k"><div class="n" id="kpiTopTeam">‚Äî</div><div class="l">Current leader</div></div>
            <div class="k"><div class="n" id="kpiTopPlayer">‚Äî</div><div class="l">Top player (sets won)</div></div>
          </div>
          <div style="margin-top:12px" class="row">
            <button class="btn primary" id="btnPrint">Print</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="hd"><h2 class="title">Latest Results</h2><div class="muted">Most recent uploaded matches</div></div>
      <div class="bd" id="latestResults"></div>
    </div>
  </section>

  <!-- TEAMS -->
  <section id="view-teams" class="view" hidden>
    <div class="card">
      <div class="hd">
        <h2 class="title">Teams & Players</h2>
        <div class="muted">Player 1 = strongest ‚Ä¢ Player 4 = developing</div>
      </div>
      <div class="bd" id="teamsGrid"></div>
    </div>
  </section>

  <!-- FIXTURES -->
  <section id="view-fixtures" class="view" hidden>
    <div class="card">
      <div class="hd">
        <div class="row" style="justify-content:space-between">
          <div>
            <h2 class="title">Fixtures</h2>
            <div class="muted">Rounds 1‚Äì14</div>
          </div>
          <div class="row">
            <span class="hint">Jump to round:</span>
            <select id="roundJump"></select>
            <button class="btn" id="btnGo">Go</button>
          </div>
        </div>
      </div>
      <div class="bd" id="fixturesList"></div>
    </div>
  </section>

  <!-- UPLOAD SCORES -->
  <section id="view-results" class="view" hidden>
    <div class="card">
      <div class="hd">
        <div class="row" style="justify-content:space-between">
          <div>
            <h2 class="title">Upload Scores</h2>
            <div class="muted">Requires code: BTC1818</div>
          </div>
          <div class="row" id="resultsTools" hidden>
            <button class="btn" id="btnClearMatch">Clear match</button>
            <button class="btn danger" id="btnResetAll">Reset all</button>
            <button class="btn" id="btnLock">Lock</button>
          </div>
        </div>
      </div>

      <div class="bd">
        <div id="gateArea" class="gateBox">
          <div class="badge">Protected</div>
          <div class="title" style="margin-top:10px">Enter access code</div>
          <div class="muted" style="margin-top:6px">This limits score entry to captains / organisers.</div>
          <div class="row" style="margin-top:12px">
            <input id="gateCode" type="password" placeholder="Code" autocomplete="off" style="min-width:220px" />
            <button class="btn primary" id="btnUnlock">Unlock</button>
          </div>
          <div class="hint" id="gateHint" style="margin-top:10px">Once unlocked, this device stays unlocked until you press ‚ÄúLock‚Äù.</div>
        </div>

        <div id="resultsArea" hidden>
          <div class="row" style="margin-bottom:12px">
            <span class="hint">Round:</span>
            <select id="roundSelect"></select>
            <span class="hint">Match:</span>
            <select id="matchSelect"></select>
            <button class="btn primary" id="btnLoadSheet">Load score sheet</button>
          </div>

          <div class="row" style="margin-bottom:10px">
            <span class="badge" id="cloudStatus">Loading‚Ä¶</span>
            <span class="muted" id="cloudStatusMsg"></span>
          </div>

          <div id="sheetHost"></div>
          <div class="foot">Enter games for each set. Standard format is 6‚Äìx (first to 6). Warnings are allowed; you can still save.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- LADDER -->
  <section id="view-ladder" class="view" hidden>
    <div class="card">
      <div class="hd"><h2 class="title">Ladder</h2><div class="muted">Tie-breakers: Points ‚Üí Set Differential ‚Üí Sets Won ‚Üí Team #</div></div>
      <div class="bd">
        <div id="ladderTable"></div>
        <div class="foot">Scoring: 1 point per set won + 2 bonus points if you win the night (no bonus on a tie).</div>
      </div>
    </div>
  </section>

  <!-- FINALS -->
  <section id="view-finals" class="view" hidden>
    <div class="grid two">
      <div class="card">
        <div class="hd">
          <div class="row" style="justify-content:space-between">
            <div>
              <h2 class="title">Finals</h2>
              <div class="muted">Auto-updates as standings change (Top 4)</div>
            </div>
            <span class="pill"><span class="dot"></span><span id="finalsStatusPill">Live standings</span></span>
          </div>
        </div>
        <div class="bd">
          <div id="finalsBracket"></div>
          <div class="foot">Shows the current Top 4 based on the ladder. After Round 14 it becomes the final bracket.</div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><h2 class="title">Finals Dates</h2><div class="muted">Edit in CONFIG</div></div>
        <div class="bd">
          <table>
            <thead><tr><th>Stage</th><th>Date</th><th>Match</th></tr></thead>
            <tbody>
              <tr><td>Elimination</td><td id="dateElim">TBA</td><td>3rd vs 4th</td></tr>
              <tr><td>Qualifying</td><td id="dateQual">TBA</td><td>1st vs 2nd</td></tr>
              <tr><td>Preliminary</td><td id="datePrelim">TBA</td><td>Loser (1v2) vs Winner (3v4)</td></tr>
              <tr><td>Grand Final</td><td id="dateGF">TBA</td><td>Winner (1v2) vs Winner (Prelim)</td></tr>
            </tbody>
          </table>
          <div class="foot">Matchups update automatically from the ladder.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- PLAYER STATS -->
  <section id="view-players" class="view" hidden>
    <div class="card">
      <div class="hd"><h2 class="title">Player Statistics</h2><div class="muted">Tracking <b>Sets Won</b> and <b>Games Won</b></div></div>
      <div class="bd">
        <div id="playerStatsTable"></div>
        <div class="foot">Leaderboard sorts by Sets Won, then Games Won, then Win % (min 6 sets), then Sets Played.</div>
      </div>
    </div>
  </section>

  <!-- RULES -->
  <section id="view-rules" class="view" hidden>
    <div class="card">
      <div class="hd"><h2 class="title">Rules</h2><div class="muted">Berwick Thursday Night Comp</div></div>
      <div class="bd">
        <ul style="margin:0; padding-left:18px; line-height:1.55">
          <li>Each Thursday: <b>Team of 4</b> plays another <b>Team of 4</b>.</li>
          <li>There are <b>6 doubles sets</b> in this order:</li>
          <ul>
            <li><b>1+2</b> vs <b>1+2</b></li>
            <li><b>3+4</b> vs <b>3+4</b></li>
            <li><b>1+3</b> vs <b>1+3</b></li>
            <li><b>2+4</b> vs <b>2+4</b></li>
            <li><b>1+4</b> vs <b>1+4</b></li>
            <li><b>2+3</b> vs <b>2+3</b></li>
          </ul>
          <li>First team to <b>6 games</b> wins the set.</li>
          <li>Night points: <b>1 point per set won</b> + <b>2 bonus points</b> if you win more sets overall.</li>
          <li>If it‚Äôs tied on sets (3‚Äì3), <b>no bonus points</b> are awarded.</li>
        </ul>
      </div>
    </div>
  </section>
</main>

<dialog id="confirmDialog">
  <div class="modal-hd">
    <div class="row" style="justify-content:space-between">
      <div>
        <h3 class="title" style="margin-top:8px" id="confirmTitle">Confirm</h3>
        <div class="muted" id="confirmMsg"></div>
      </div>
      <button class="btn" id="btnConfirmClose">Close</button>
    </div>
  </div>
  <div class="modal-ft">
    <button class="btn" id="btnConfirmNo">Cancel</button>
    <button class="btn danger" id="btnConfirmYes">Yes</button>
  </div>
</dialog>

<script>
/* ============================================================
   CONFIG ‚Äî IMPORTANT
   1) Deploy Apps Script web app
   2) Paste URL below
   ============================================================ */
const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbw8GVO1VqmhHyNhgoVr25lvkROu0D0lrqDA0RQqNQ0e3nxs8ZpJl_uXJe0XIvJjt-H1BQ/exec";  // <-- paste your Apps Script web app URL
const API_KEY = "BTC1818"; // must match Code.gs API_KEY

/* Finals dates (edit these) */
const FINALS_DATES = {
  elimination: "TBA",
  qualifying: "TBA",
  preliminary: "TBA",
  grandFinal: "TBA"
};

/* Upload gate */
const SCORE_ENTRY_CODE = "BTC1818";
const SEASON_KEY = "btc_thursday_autumn_2026_v2_cloud";
const UNLOCK_KEY = SEASON_KEY + "_upload_unlocked";

/* Teams */
const teams = {
  1:{ name:"Team 1", players:["Cooper Khalil","Simran Chawla","David Sutton","Chris Maniatakis"] },
  2:{ name:"Team 2", players:["Enrique Lopez","Craig Kitner","Josh Bury","Varun Sridhara"] },
  3:{ name:"Team 3", players:["Michael Rominger","David Ng","Cameron Rush","Alan Chumacero"] },
  4:{ name:"Team 4", players:["Jonathan Rogers","Rafa Bouzinelos","David Thurmond","Andrew Watson"] },
  5:{ name:"Team 5", players:["Chung Tan","Huss Shafai","Tom Maloney","Brett Kurz"] },
  6:{ name:"Team 6", players:["Vignesh Pakkiam","Eric Castricum","Stephen Saunders","Mark Findlay"] },
  7:{ name:"Team 7", players:["Chris Scott","Justin Hermann","Nick Teo","Dishit Devasia"] },
};

/* Fixtures */
const rounds = [
  { r:1,  date:"05-Feb-26", matches:[[1,6],[2,5],[3,4],[7,null]] },
  { r:2,  date:"12-Feb-26", matches:[[4,2],[5,1],[6,7],[3,null]] },
  { r:3,  date:"19-Feb-26", matches:[[2,7],[3,6],[4,5],[1,null]] },
  { r:4,  date:"26-Feb-26", matches:[[5,3],[6,2],[7,1],[4,null]] },
  { r:5,  date:"05-Mar-26", matches:[[3,1],[4,7],[5,6],[2,null]] },
  { r:6,  date:"12-Mar-26", matches:[[6,4],[7,3],[1,2],[5,null]] },
  { r:7,  date:"19-Mar-26", matches:[[7,5],[1,4],[2,3],[6,null]] },
  { r:8,  date:"26-Mar-26", matches:[[1,6],[2,5],[3,4],[7,null]] },
  { r:9,  date:"23-Apr-26", matches:[[4,2],[5,1],[6,7],[3,null]] },
  { r:10, date:"30-Apr-26", matches:[[2,7],[3,6],[4,5],[1,null]] },
  { r:11, date:"07-May-26", matches:[[5,3],[6,2],[7,1],[4,null]] },
  { r:12, date:"14-May-26", matches:[[3,1],[4,7],[5,6],[2,null]] },
  { r:13, date:"21-May-26", matches:[[6,4],[7,3],[1,2],[5,null]] },
  { r:14, date:"28-May-26", matches:[[7,5],[1,4],[2,3],[6,null]] },
];

/* Pairing order */
const pairings = [
  { key:"12", label:"1 + 2", a:[1,2], b:[1,2] },
  { key:"34", label:"3 + 4", a:[3,4], b:[3,4] },
  { key:"13", label:"1 + 3", a:[1,3], b:[1,3] },
  { key:"24", label:"2 + 4", a:[2,4], b:[2,4] },
  { key:"14", label:"1 + 4", a:[1,4], b:[1,4] },
  { key:"23", label:"2 + 3", a:[2,3], b:[2,3] },
];

/* ---------- State ---------- */
let RESULTS = {}; // matchKey -> record (loaded from Google Sheet)

/* ---------- Helpers ---------- */
const $ = (sel)=>document.querySelector(sel);
const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
function escapeHtml_(s){
  return String(s).replace(/[&<>"']/g, (c)=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));
}
function matchId(roundNum, matchIndex){ return `r${roundNum}_m${matchIndex}`; }
function teamName(id){ return teams[id]?.name ?? `Team ${id}`; }

/* ---------- Cloud API ---------- */
function cloudReady_(){
  return SHEETS_WEBAPP_URL && !SHEETS_WEBAPP_URL.includes("PASTE_YOUR_WEB_APP_URL");
}
async function cloudDump_(){
  const url = new URL(SHEETS_WEBAPP_URL);
  url.searchParams.set("action","dump");
  url.searchParams.set("key", API_KEY);
  const res = await fetch(url.toString(), { method:"GET" });
  if (!res.ok) throw new Error("Could not load from Google Sheets (dump).");
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || "Dump failed.");
  return json.results || {};
}
async function cloudUpsert_(matchKey, record){
  const res = await fetch(SHEETS_WEBAPP_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ action:"upsert", key: API_KEY, matchKey, record })
  });
  if (!res.ok) throw new Error("Could not save to Google Sheets (upsert).");
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || "Upsert failed.");
}
async function cloudDelete_(matchKey){
  const res = await fetch(SHEETS_WEBAPP_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ action:"delete", key: API_KEY, matchKey })
  });
  if (!res.ok) throw new Error("Could not delete from Google Sheets.");
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || "Delete failed.");
}
async function cloudReset_(){
  const res = await fetch(SHEETS_WEBAPP_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ action:"reset", key: API_KEY })
  });
  if (!res.ok) throw new Error("Could not reset Google Sheets.");
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || "Reset failed.");
}

/* ---------- Team chip popover ---------- */
function teamChipHTML(teamId){
  if (teamId == null) return `<span class="badge">Bye</span>`;
  const t = teams[teamId];
  const players = t.players.map((p,i)=>(
    `<div class="p"><span class="rank">#${i+1}</span><span class="name">${escapeHtml_(p)}</span></div>`
  )).join("");
  return `
    <span class="team-chip" data-team-chip="${teamId}">
      ${escapeHtml_(t.name)}
      <span class="team-pop" role="dialog" aria-label="${escapeHtml_(t.name)} players">
        <div class="hdr">
          <b>${escapeHtml_(t.name)}</b>
          <button class="closex" type="button" data-close-pop="1">Close</button>
        </div>
        ${players}
      </span>
    </span>
  `;
}
function attachTeamChipHandlers_(){
  document.addEventListener("click", (e)=>{
    const chip = e.target.closest?.(".team-chip");
    if (!chip){
      $$(".team-chip[data-open='true']").forEach(c=>c.removeAttribute("data-open"));
    }
  }, {capture:true});
  $$(".team-chip").forEach(chip=>{
    chip.addEventListener("click", (e)=>{
      const closeBtn = e.target.closest?.("[data-close-pop]");
      if (closeBtn){
        chip.removeAttribute("data-open");
        e.stopPropagation();
        return;
      }
      if (window.matchMedia("(max-width: 760px)").matches){
        const open = chip.getAttribute("data-open") === "true";
        $$(".team-chip[data-open='true']").forEach(c=>c.removeAttribute("data-open"));
        if (!open) chip.setAttribute("data-open","true");
        e.stopPropagation();
      }
    });
  });
}

/* ---------- Gate ---------- */
function isUnlocked_(){ return localStorage.getItem(UNLOCK_KEY) === "1"; }
function setUnlocked_(val){
  if (val) localStorage.setItem(UNLOCK_KEY, "1");
  else localStorage.removeItem(UNLOCK_KEY);
  updateUploadTab_();
}
function updateUploadTab_(){
  const tab = $("#tab-results");
  tab.textContent = isUnlocked_() ? "Upload Scores" : "Upload Scores üîí";
}
function renderGate_(){
  const unlocked = isUnlocked_();
  $("#gateArea").hidden = unlocked;
  $("#resultsArea").hidden = !unlocked;
  $("#resultsTools").hidden = !unlocked;
}
function tryUnlock_(){
  const input = $("#gateCode").value.trim();
  if (input === SCORE_ENTRY_CODE){
    setUnlocked_(true);
    $("#gateCode").value = "";
    renderGate_();
    toast_("Unlocked ‚úî");
    populateRoundSelect();
    $("#roundSelect").value = "1";
    populateMatchSelect();
  } else {
    toast_("Wrong code");
    $("#gateCode").focus();
  }
}
function lock_(){
  setUnlocked_(false);
  $("#sheetHost").innerHTML = "";
  renderGate_();
  toast_("Locked üîí");
}

/* ---------- Scoring ---------- */
function calcNightPoints(aSets, bSets){
  aSets = Number(aSets)||0; bSets = Number(bSets)||0;
  let aPts = aSets, bPts = bSets;
  if (aSets > bSets) aPts += 2;
  else if (bSets > aSets) bPts += 2;
  return {aPts, bPts};
}
function decideSetWinner(aGames, bGames){
  aGames = Number(aGames); bGames = Number(bGames);
  if (!Number.isFinite(aGames) || !Number.isFinite(bGames)) return {winner: null, status:"empty"};
  if (aGames === 6 && bGames !== 6) return {winner:"A", status:"ok"};
  if (bGames === 6 && aGames !== 6) return {winner:"B", status:"ok"};
  if ((aGames >= 6 || bGames >= 6) && aGames !== bGames){
    return {winner: (aGames > bGames ? "A":"B"), status:"warn"};
  }
  return {winner: null, status:"warn"};
}

/* ---------- Ladder ---------- */
function buildLadder(){
  const base = {};
  Object.keys(teams).forEach(id=>{
    base[id] = { teamId:Number(id), played:0, points:0, setsWon:0, setsLost:0, nightsWon:0, nightsLost:0, nightsTied:0 };
  });

  for (const m of Object.values(RESULTS)){
    if (!m || m.a == null || m.b == null) continue;
    const A = base[m.a], B = base[m.b];
    if (!A || !B) continue;

    A.played++; B.played++;
    A.points += Number(m.aPts)||0;
    B.points += Number(m.bPts)||0;

    A.setsWon += Number(m.aSets)||0;
    A.setsLost += Number(m.bSets)||0;
    B.setsWon += Number(m.bSets)||0;
    B.setsLost += Number(m.aSets)||0;

    if (m.aSets > m.bSets){ A.nightsWon++; B.nightsLost++; }
    else if (m.bSets > m.aSets){ B.nightsWon++; A.nightsLost++; }
    else { A.nightsTied++; B.nightsTied++; }
  }

  const rows = Object.values(base);
  rows.sort((x,y)=>{
    const p = y.points - x.points; if (p) return p;
    const sd = (y.setsWon - y.setsLost) - (x.setsWon - x.setsLost); if (sd) return sd;
    const sw = y.setsWon - x.setsWon; if (sw) return sw;
    return x.teamId - y.teamId;
  });
  return rows;
}

/* ---------- Player stats (Sets Won + Games Won) ---------- */
function buildPlayerStats(){
  const stats = new Map();
  for (const [tid, t] of Object.entries(teams)){
    t.players.forEach(p=>stats.set(p, {
      name:p, teamId:Number(tid),
      setsWon:0, setsPlayed:0,
      gamesWon:0, gamesPlayed:0
    }));
  }

  for (const m of Object.values(RESULTS)){
    if (!m || m.a == null || m.b == null) continue;
    if (!m.pairs) continue;

    const teamA = teams[m.a], teamB = teams[m.b];

    for (const pr of pairings){
      const res = m.pairs[pr.key];
      if (!res) continue;

      const aG = Number(res.a);
      const bG = Number(res.b);
      if (!Number.isFinite(aG) || !Number.isFinite(bG)) continue;

      const d = decideSetWinner(aG, bG);
      if (!d.winner) continue;

      const aPlayers = pr.a.map(n=>teamA.players[n-1]);
      const bPlayers = pr.b.map(n=>teamB.players[n-1]);

      for (const p of aPlayers){
        const s = stats.get(p);
        s.gamesPlayed += (aG + bG);
        s.gamesWon += aG;
        s.setsPlayed += 1;
        if (d.winner === "A") s.setsWon += 1;
      }
      for (const p of bPlayers){
        const s = stats.get(p);
        s.gamesPlayed += (aG + bG);
        s.gamesWon += bG;
        s.setsPlayed += 1;
        if (d.winner === "B") s.setsWon += 1;
      }
    }
  }

  const rows = Array.from(stats.values()).map(s=>({
    ...s,
    winPct: s.setsPlayed ? (s.setsWon / s.setsPlayed) : 0,
    gamesPct: s.gamesPlayed ? (s.gamesWon / s.gamesPlayed) : 0
  }));

  rows.sort((a,b)=>{
    const sw = b.setsWon - a.setsWon; if (sw) return sw;
    const gw = b.gamesWon - a.gamesWon; if (gw) return gw;
    const aQ = a.setsPlayed >= 6, bQ = b.setsPlayed >= 6;
    if (aQ !== bQ) return (bQ ? 1 : -1);
    const wp = b.winPct - a.winPct; if (wp) return wp;
    const sp = b.setsPlayed - a.setsPlayed; if (sp) return sp;
    return a.name.localeCompare(b.name);
  });

  return rows;
}

/* ---------- Finals ---------- */
function renderFinals(){
  $("#dateElim").textContent = FINALS_DATES.elimination || "TBA";
  $("#dateQual").textContent = FINALS_DATES.qualifying || "TBA";
  $("#datePrelim").textContent = FINALS_DATES.preliminary || "TBA";
  $("#dateGF").textContent = FINALS_DATES.grandFinal || "TBA";

  const ladder = buildLadder();
  const top4 = ladder.slice(0,4).map(x=>x.teamId);
  const [t1,t2,t3,t4] = top4;

  const round14 = rounds.find(r=>r.r===14);
  let round14Complete = true;
  if (round14){
    for (let i=0;i<round14.matches.length;i++){
      const [a,b] = round14.matches[i];
      if (b == null) continue;
      const id = matchId(14, i);
      if (!RESULTS[id]) { round14Complete = false; break; }
    }
  } else round14Complete = false;

  $("#finalsStatusPill").textContent = round14Complete ? "Locked (after Round 14)" : "Live standings";

  $("#finalsBracket").innerHTML = `
    <div class="bracket">
      <div class="stage">
        <b>Qualifying (1st vs 2nd)</b>
        <div class="subline">${escapeHtml_(FINALS_DATES.qualifying || "TBA")}</div>
        <div class="match">${t1?teamChipHTML(t1):`<span class="badge warn">TBA</span>`} <span class="muted">vs</span> ${t2?teamChipHTML(t2):`<span class="badge warn">TBA</span>`}</div>
        <div class="subline">Winner ‚Üí Grand Final ‚Ä¢ Loser ‚Üí Preliminary</div>
      </div>

      <div class="stage">
        <b>Elimination (3rd vs 4th)</b>
        <div class="subline">${escapeHtml_(FINALS_DATES.elimination || "TBA")}</div>
        <div class="match">${t3?teamChipHTML(t3):`<span class="badge warn">TBA</span>`} <span class="muted">vs</span> ${t4?teamChipHTML(t4):`<span class="badge warn">TBA</span>`}</div>
        <div class="subline">Loser eliminated ‚Ä¢ Winner ‚Üí Preliminary</div>
      </div>

      <div class="stage">
        <b>Preliminary</b>
        <div class="subline">${escapeHtml_(FINALS_DATES.preliminary || "TBA")}</div>
        <div class="match"><span class="muted">Loser (1v2)</span> <span class="muted">vs</span> <span class="muted">Winner (3v4)</span></div>
      </div>

      <div class="stage">
        <b>Grand Final</b>
        <div class="subline">${escapeHtml_(FINALS_DATES.grandFinal || "TBA")}</div>
        <div class="match"><span class="muted">Winner (1v2)</span> <span class="muted">vs</span> <span class="muted">Winner (Prelim)</span></div>
      </div>

      <div class="muted" style="font-size:12px">
        Current Top 4:
        ${top4.map((tid,idx)=>`<span class="badge">${idx+1}</span> ${teamChipHTML(tid)}`).join(" ‚Ä¢ ")}
      </div>
    </div>
  `;
  attachTeamChipHandlers_();
}

/* ---------- Render: Home ---------- */
function getNextRound(){
  for (const round of rounds){
    let allDone = true;
    for (let i=0;i<round.matches.length;i++){
      const [a,b] = round.matches[i];
      if (b == null) continue;
      const id = matchId(round.r, i);
      if (!RESULTS[id]) { allDone = false; break; }
    }
    if (!allDone) return round;
  }
  return null;
}

function renderHome(){
  const next = getNextRound();
  if (!next){
    $("#nextRoundPill").textContent = "Season complete";
    $("#nextRoundDate").textContent = "";
    $("#nextRoundMatches").innerHTML = `<div class="muted">All rounds have results.</div>`;
  } else {
    $("#nextRoundPill").textContent = `Round ${next.r}`;
    $("#nextRoundDate").textContent = next.date;
    $("#nextRoundMatches").innerHTML = next.matches.map((m,idx)=>{
      const [a,b] = m;
      if (b == null) return `
        <div class="row" style="justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--border)">
          <div>${teamChipHTML(a)}</div><div class="muted">Bye</div>
        </div>`;
      const id = matchId(next.r, idx);
      const res = RESULTS[id];
      const summary = res ? `${res.aSets}‚Äì${res.bSets} (pts ${res.aPts}‚Äì${res.bPts})` : "Not played";
      return `
        <div class="row" style="justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--border)">
          <div>${teamChipHTML(a)} <span class="muted">vs</span> ${teamChipHTML(b)}</div>
          <div class="muted">${summary}</div>
        </div>`;
    }).join("");
  }

  const latest = Object.entries(RESULTS)
    .map(([k,v])=>({k,v}))
    .filter(x=>x.v && x.v.a!=null && x.v.b!=null)
    .sort((x,y)=>(y.v.ts||0)-(x.v.ts||0))
    .slice(0,6);

  if (!latest.length){
    $("#latestResults").innerHTML = `<div class="muted">No results uploaded yet.</div>`;
  } else {
    $("#latestResults").innerHTML = `
      <table>
        <thead><tr><th>Round</th><th>Match</th><th class="right">Sets</th><th class="right">Points</th><th class="right">Total Games</th></tr></thead>
        <tbody>
          ${latest.map(x=>{
            const [rPart] = x.k.split("_");
            const r = Number(rPart.replace("r",""));
            const date = rounds.find(rr=>rr.r===r)?.date ?? "";
            const m = x.v;
            return `
              <tr>
                <td>R${r} <span class="muted">${date}</span></td>
                <td>${teamChipHTML(m.a)} <span class="muted">vs</span> ${teamChipHTML(m.b)}</td>
                <td class="right"><b>${m.aSets}‚Äì${m.bSets}</b></td>
                <td class="right"><span class="muted">${m.aPts}‚Äì${m.bPts}</span></td>
                <td class="right"><span class="muted">${m.aGamesTotal||0}‚Äì${m.bGamesTotal||0}</span></td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    `;
    attachTeamChipHandlers_();
  }
}

/* ---------- Render: Teams ---------- */
function renderTeams(){
  const ids = Object.keys(teams).map(Number).sort((a,b)=>a-b);
  $("#teamsGrid").innerHTML = `
    <div class="grid" style="grid-template-columns:repeat(2,1fr); gap:14px">
      ${ids.map(id=>{
        const t = teams[id];
        return `
          <div class="card" style="background:rgba(255,255,255,.03); box-shadow:none; border-radius:14px">
            <div class="bd">
              <div class="badge">Team ${id}</div>
              <h3 class="title" style="margin:10px 0 0">${escapeHtml_(t.name)}</h3>
              <div style="margin-top:10px">
                ${t.players.map((p,i)=>`
                  <div class="row" style="justify-content:space-between">
                    <span class="muted">Player ${i+1}</span><span>${escapeHtml_(p)}</span>
                  </div>`).join("")}
              </div>
            </div>
          </div>
        `;
      }).join("")}
    </div>
  `;
}

/* ---------- Render: Fixtures ---------- */
function renderFixtures(){
  const host = $("#fixturesList");
  host.innerHTML = "";
  for (const round of rounds){
    const rows = round.matches.map((m, idx)=>{
      const [a,b] = m;
      const id = matchId(round.r, idx);
      const res = RESULTS[id];
      const badge = !b ? `<span class="badge">Bye</span>` :
        (res ? `<span class="badge good">Recorded</span>` : `<span class="badge">Not played</span>`);
      const summary = (!b) ? "‚Äî" : (res ? `${res.aSets}‚Äì${res.bSets} (pts ${res.aPts}‚Äì${res.bPts})` : "‚Äî");
      return `
        <tr>
          <td>${teamChipHTML(a)}</td>
          <td class="center">${b ? "vs" : "‚Äî"}</td>
          <td>${b ? teamChipHTML(b) : `<span class="muted">Bye</span>`}</td>
          <td class="right">${badge} <span class="muted" style="margin-left:8px">${summary}</span></td>
        </tr>
      `;
    }).join("");

    host.insertAdjacentHTML("beforeend", `
      <div class="card" id="round-${round.r}" style="background:rgba(255,255,255,.02); box-shadow:none; border-radius:14px; margin-bottom:14px">
        <div class="bd">
          <div class="row" style="justify-content:space-between; margin-bottom:10px">
            <div>
              <div class="badge">Round ${round.r}</div>
              <div class="muted" style="margin-top:6px">${round.date}</div>
            </div>
            <button class="btn" data-open-round="${round.r}">Upload scores</button>
          </div>
          <table>
            <thead><tr><th>Team A</th><th class="center"></th><th>Team B</th><th class="right">Result</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>
    `);
  }

  $$("[data-open-round]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      setView("results");
      if (!isUnlocked_()){
        $("#gateCode").focus();
        return;
      }
      const r = Number(btn.getAttribute("data-open-round"));
      $("#roundSelect").value = String(r);
      populateMatchSelect();
      $("#btnLoadSheet").click();
    });
  });

  attachTeamChipHandlers_();
}

/* ---------- Render: Ladder ---------- */
function renderLadder(){
  const ladder = buildLadder();
  $("#ladderTable").innerHTML = `
    <table>
      <thead>
        <tr>
          <th class="right">#</th>
          <th>Team</th>
          <th class="right">P</th>
          <th class="right">Pts</th>
          <th class="right">Sets W</th>
          <th class="right">Sets L</th>
          <th class="right">Set Diff</th>
          <th class="right">Nights W</th>
          <th class="right">Nights L</th>
          <th class="right">Tied</th>
        </tr>
      </thead>
      <tbody>
        ${ladder.map((row, i)=>{
          const diff = row.setsWon - row.setsLost;
          return `
            <tr>
              <td class="right">${i+1}</td>
              <td>${teamChipHTML(row.teamId)}</td>
              <td class="right">${row.played}</td>
              <td class="right"><b>${row.points}</b></td>
              <td class="right">${row.setsWon}</td>
              <td class="right">${row.setsLost}</td>
              <td class="right">${diff}</td>
              <td class="right">${row.nightsWon}</td>
              <td class="right">${row.nightsLost}</td>
              <td class="right">${row.nightsTied}</td>
            </tr>
          `;
        }).join("")}
      </tbody>
    </table>
  `;
  attachTeamChipHandlers_();

  const matchCount = Object.values(RESULTS).filter(m=>m && m.a!=null && m.b!=null).length;
  const roundsDone = new Set(Object.keys(RESULTS).map(k=>k.split("_")[0])).size;
  $("#kpiRoundsDone").textContent = String(roundsDone);
  $("#kpiMatchesDone").textContent = String(matchCount);

  const leader = ladder[0]?.teamId;
  $("#kpiTopTeam").textContent = leader ? `Team ${leader}` : "‚Äî";

  const players = buildPlayerStats();
  $("#kpiTopPlayer").textContent = players[0]?.name ?? "‚Äî";
}

/* ---------- Render: Player stats ---------- */
function renderPlayerStats(){
  const rows = buildPlayerStats();
  $("#playerStatsTable").innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Player</th>
          <th>Team</th>
          <th class="right">Sets Won</th>
          <th class="right">Sets Played</th>
          <th class="right">Win %</th>
          <th class="right">Games Won</th>
          <th class="right">Games Played</th>
          <th class="right">Games %</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r=>{
          const pct = r.setsPlayed ? (r.winPct*100).toFixed(1) : "0.0";
          const gPct = r.gamesPlayed ? (r.gamesPct*100).toFixed(1) : "0.0";
          const badge = r.setsPlayed < 6 ? `<span class="badge warn" title="Small sample size">&lt;6 sets</span>` : "";
          return `
            <tr>
              <td>${escapeHtml_(r.name)} ${badge}</td>
              <td>${teamChipHTML(r.teamId)}</td>
              <td class="right"><b>${r.setsWon}</b></td>
              <td class="right">${r.setsPlayed}</td>
              <td class="right">${pct}%</td>
              <td class="right"><b>${r.gamesWon}</b></td>
              <td class="right">${r.gamesPlayed}</td>
              <td class="right">${gPct}%</td>
            </tr>
          `;
        }).join("")}
      </tbody>
    </table>
  `;
  attachTeamChipHandlers_();
}

/* ---------- Upload scores UI ---------- */
function populateRoundSelect(){
  const rs = $("#roundSelect");
  const rj = $("#roundJump");
  rs.innerHTML = "";
  rj.innerHTML = "";
  rounds.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = String(r.r);
    opt.textContent = `Round ${r.r} ‚Äî ${r.date}`;
    rs.appendChild(opt);

    const opt2 = document.createElement("option");
    opt2.value = String(r.r);
    opt2.textContent = `Round ${r.r}`;
    rj.appendChild(opt2);
  });
}
function populateMatchSelect(){
  const r = Number($("#roundSelect").value);
  const round = rounds.find(x=>x.r===r);
  const ms = $("#matchSelect");
  ms.innerHTML = "";
  round.matches.forEach((m,idx)=>{
    const [a,b] = m;
    if (b == null) return;
    const opt = document.createElement("option");
    opt.value = String(idx);
    opt.textContent = `${teamName(a)} vs ${teamName(b)}`;
    ms.appendChild(opt);
  });
  $("#btnLoadSheet").disabled = ms.options.length === 0;
}
function getSelectedMatch_(){
  const r = Number($("#roundSelect").value);
  const idx = Number($("#matchSelect").value);
  const round = rounds.find(x=>x.r===r);
  const [a,b] = round.matches[idx];
  return { round, r, idx, a, b, id: matchId(r, idx) };
}

function renderScoreSheet(){
  const host = $("#sheetHost");
  host.innerHTML = "";
  const ms = $("#matchSelect");
  if (!ms.options.length){
    host.innerHTML = `<div class="muted">No match selected.</div>`;
    return;
  }
  const {round, r, a, b, id} = getSelectedMatch_();
  const existing = RESULTS[id];
  const teamA = teams[a], teamB = teams[b];
  const pairsObj = existing?.pairs || {};

  host.innerHTML = `
    <div class="sheet" data-match-id="${id}">
      <div class="head">
        <div class="meta">
          <div class="line"><b>Berwick Tennis Club</b> ‚Ä¢ Thursday Night Comp ‚Ä¢ <b>Autumn 2026</b></div>
          <div class="line">Date: <b>${round.date}</b> ‚Ä¢ Round: <b>${r}</b></div>
          <div class="line">${teamName(a)} vs ${teamName(b)}</div>
        </div>
        <div class="row">
          <span class="badge">Enter games (first to 6)</span>
          <button class="btn primary" id="btnSaveSheet">Save to Google Sheets</button>
        </div>

        <div class="teams">
          <div class="teamBox">
            <div class="tname">${teamName(a)}</div>
            <div class="plist">
              ${teamA.players.map((p,i)=>`
                <div class="prow"><span class="r">#${i+1}</span><span>${escapeHtml_(p)}</span></div>
              `).join("")}
            </div>
          </div>
          <div class="teamBox">
            <div class="tname">${teamName(b)}</div>
            <div class="plist">
              ${teamB.players.map((p,i)=>`
                <div class="prow"><span class="r">#${i+1}</span><span>${escapeHtml_(p)}</span></div>
              `).join("")}
            </div>
          </div>
        </div>
      </div>

      <div>
        ${pairings.map(pr=>{
          const saved = pairsObj[pr.key] || {};
          const aVal = (saved.a ?? "");
          const bVal = (saved.b ?? "");
          const aNames = pr.a.map(n=>teamA.players[n-1]).join(" & ");
          const bNames = pr.b.map(n=>teamB.players[n-1]).join(" & ");
          return `
            <div class="gridRow" data-pair="${pr.key}">
              <div class="pairTag">${pr.label}</div>
              <div class="cell">
                <span class="who">${escapeHtml_(aNames)}</span>
                <input type="number" min="0" max="10" step="1" inputmode="numeric" data-side="a" value="${aVal}" placeholder="Games" />
              </div>
              <div class="cell">
                <span class="who">${escapeHtml_(bNames)}</span>
                <input type="number" min="0" max="10" step="1" inputmode="numeric" data-side="b" value="${bVal}" placeholder="Games" />
              </div>
              <div class="cell rightish" style="justify-content:flex-end">
                <span class="winMark" data-win="${pr.key}">‚Äî</span>
              </div>
            </div>
          `;
        }).join("")}
      </div>

      <div class="bd">
        <div id="sheetWarnings"></div>
        <div class="totals">
          <div class="tot">
            <div class="k">Sets</div>
            <div class="v"><span id="aSetsOut">0</span> ‚Äì <span id="bSetsOut">0</span></div>
            <div class="muted" style="margin-top:6px">${teamName(a)} vs ${teamName(b)}</div>
          </div>
          <div class="tot">
            <div class="k">Points (incl. bonus)</div>
            <div class="v"><span id="aPtsOut">0</span> ‚Äì <span id="bPtsOut">0</span></div>
            <div class="muted" style="margin-top:6px">+2 bonus for winning the night</div>
          </div>
          <div class="tot">
            <div class="k">Total Games</div>
            <div class="v"><span id="aGamesOut">0</span> ‚Äì <span id="bGamesOut">0</span></div>
            <div class="muted" style="margin-top:6px">Sum across 6 sets</div>
          </div>
        </div>
      </div>
    </div>
  `;

  const sheet = host.querySelector(".sheet");
  sheet.querySelectorAll("input[type='number']").forEach(inp=>{
    inp.addEventListener("input", ()=>recalcSheet_(sheet, a, b));
  });

  sheet.querySelector("#btnSaveSheet").addEventListener("click", async ()=>{
    if (!cloudReady_()){
      alert("Cloud URL not set. Paste your Apps Script Web App URL into SHEETS_WEBAPP_URL.");
      return;
    }
    setCloudStatus_("Saving‚Ä¶", "warn", "Writing to the shared sheet...");
    const computed = recalcSheet_(sheet, a, b, true);
    if (!computed.ok){
      openConfirm("Save with warnings?", "Some sets don‚Äôt look like a standard 6‚Äìx score. Save anyway?", async ()=>{
        await saveSheetCloud_(sheet, a, b, computed);
      });
      return;
    }
    await saveSheetCloud_(sheet, a, b, computed);
  });

  recalcSheet_(sheet, a, b);
}

function recalcSheet_(sheetEl, aTeamId, bTeamId, returnObject=false){
  const warnings = [];
  const pairsOut = {};
  let aSets = 0, bSets = 0;
  let aGamesTotal = 0, bGamesTotal = 0;
  let ok = true;

  for (const pr of pairings){
    const row = sheetEl.querySelector(`[data-pair="${pr.key}"]`);
    const aInp = row.querySelector(`input[data-side="a"]`);
    const bInp = row.querySelector(`input[data-side="b"]`);
    const aVal = aInp.value === "" ? null : Number(aInp.value);
    const bVal = bInp.value === "" ? null : Number(bInp.value);

    if (aVal != null) aGamesTotal += aVal;
    if (bVal != null) bGamesTotal += bVal;

    pairsOut[pr.key] = { a: (aVal==null?"":aVal), b: (bVal==null?"":bVal) };

    const winBadge = row.querySelector(`[data-win="${pr.key}"]`);
    const d = decideSetWinner(aVal, bVal);

    if (d.status === "empty"){
      winBadge.textContent = "‚Äî";
      winBadge.className = "winMark";
      continue;
    }

    if (d.winner === "A"){
      aSets++;
      winBadge.textContent = `${teamName(aTeamId)} win`;
      winBadge.className = "winMark good";
      if (d.status === "warn"){ ok = false; warnings.push(`${pr.label}: unusual score (${aVal}‚Äì${bVal})`); winBadge.className = "winMark warn"; }
    } else if (d.winner === "B"){
      bSets++;
      winBadge.textContent = `${teamName(bTeamId)} win`;
      winBadge.className = "winMark good";
      if (d.status === "warn"){ ok = false; warnings.push(`${pr.label}: unusual score (${aVal}‚Äì${bVal})`); winBadge.className = "winMark warn"; }
    } else {
      ok = false;
      winBadge.textContent = "Check";
      winBadge.className = "winMark bad";
      warnings.push(`${pr.label}: no clear winner (${aVal}‚Äì${bVal})`);
    }
  }

  const pts = calcNightPoints(aSets, bSets);

  sheetEl.querySelector("#aSetsOut").textContent = String(aSets);
  sheetEl.querySelector("#bSetsOut").textContent = String(bSets);
  sheetEl.querySelector("#aPtsOut").textContent = String(pts.aPts);
  sheetEl.querySelector("#bPtsOut").textContent = String(pts.bPts);
  sheetEl.querySelector("#aGamesOut").textContent = String(aGamesTotal);
  sheetEl.querySelector("#bGamesOut").textContent = String(bGamesTotal);

  const warnHost = sheetEl.querySelector("#sheetWarnings");
  if (!warnings.length){
    warnHost.innerHTML = `<span class="badge good">All good</span>`;
  } else {
    warnHost.innerHTML = `
      <div class="row" style="margin-bottom:8px">
        <span class="badge warn">Warnings</span>
        <span class="muted">You can still save, but double-check these lines.</span>
      </div>
      <ul style="margin:0; padding-left:18px; color: var(--muted); line-height:1.5">
        ${warnings.map(w=>`<li>${escapeHtml_(w)}</li>`).join("")}
      </ul>
    `;
  }

  const out = { ok, pairs: pairsOut, aSets, bSets, aGamesTotal, bGamesTotal, aPts: pts.aPts, bPts: pts.bPts };
  return returnObject ? out : out;
}

async function saveSheetCloud_(sheetEl, aTeamId, bTeamId, computed){
  try{
    const id = sheetEl.getAttribute("data-match-id");
    const record = {
      a: aTeamId,
      b: bTeamId,
      pairs: Object.fromEntries(
        Object.entries(computed.pairs).map(([k,v])=>[
          k,
          { a: (v.a===""?null:Number(v.a)), b:(v.b===""?null:Number(v.b)) }
        ])
      ),
      aSets: computed.aSets,
      bSets: computed.bSets,
      aGamesTotal: computed.aGamesTotal,
      bGamesTotal: computed.bGamesTotal,
      aPts: computed.aPts,
      bPts: computed.bPts,
      ts: Date.now()
    };

    await cloudUpsert_(id, record);

    // update local memory
    RESULTS[id] = record;

    setCloudStatus_("Saved ‚úî", "good", "Saved to the shared sheet.");
    toast_("Saved ‚úî");

    renderHome();
    renderFixtures();
    renderLadder();
    renderFinals();
    renderPlayerStats();

  } catch (e){
    setCloudStatus_("Save failed", "bad", e?.message || "Could not save.");
    alert(e?.message || "Save failed");
  }
}

async function clearSelectedMatch(){
  const ms = $("#matchSelect");
  if (!ms.options.length) return;
  const {id} = getSelectedMatch_();
  if (!RESULTS[id]) { toast_("Nothing to clear"); return; }
  openConfirm("Clear this match?", "This removes the selected match from Google Sheets.", async ()=>{
    try{
      setCloudStatus_("Deleting‚Ä¶", "warn", "Removing from the shared sheet...");
      await cloudDelete_(id);
      delete RESULTS[id];
      $("#sheetHost").innerHTML = `<div class="muted">Match cleared. Load the score sheet to re-enter.</div>`;
      renderHome(); renderFixtures(); renderLadder(); renderFinals(); renderPlayerStats();
      setCloudStatus_("Deleted", "good", "Removed from the shared sheet.");
      toast_("Cleared");
    } catch(e){
      setCloudStatus_("Delete failed", "bad", e?.message || "Could not delete.");
      alert(e?.message || "Delete failed");
    }
  });
}

async function resetAllResults(){
  openConfirm("Reset ALL results?", "This deletes ALL results from Google Sheets for everyone.", async ()=>{
    try{
      setCloudStatus_("Resetting‚Ä¶", "warn", "Clearing the shared sheet...");
      await cloudReset_();
      RESULTS = {};
      $("#sheetHost").innerHTML = `<div class="muted">All results cleared.</div>`;
      renderHome(); renderFixtures(); renderLadder(); renderFinals(); renderPlayerStats();
      setCloudStatus_("Reset", "good", "All results cleared.");
      toast_("Reset");
    } catch(e){
      setCloudStatus_("Reset failed", "bad", e?.message || "Could not reset.");
      alert(e?.message || "Reset failed");
    }
  });
}

/* ---------- Cloud status UI ---------- */
function setCloudStatus_(label, kind, msg){
  const b = $("#cloudStatus");
  const m = $("#cloudStatusMsg");
  b.textContent = label;
  b.className = "badge " + (kind==="good"?"good":kind==="bad"?"bad":kind==="warn"?"warn":"");
  m.textContent = msg || "";
}

/* ---------- Confirm dialog ---------- */
function openConfirm(title, msg, onYes){
  const d = $("#confirmDialog");
  $("#confirmTitle").textContent = title;
  $("#confirmMsg").textContent = msg;
  d._onYes = onYes;
  d.showModal();
}
$("#btnConfirmClose").addEventListener("click", ()=>$("#confirmDialog").close());
$("#btnConfirmNo").addEventListener("click", ()=>$("#confirmDialog").close());
$("#btnConfirmYes").addEventListener("click", async ()=>{
  const d = $("#confirmDialog");
  const fn = d._onYes;
  d.close();
  if (typeof fn === "function") await fn();
});

/* ---------- Toast ---------- */
let toastTimer = null;
function toast_(msg){
  let el = document.getElementById("toast");
  if (!el){
    el = document.createElement("div");
    el.id = "toast";
    el.style.position = "fixed";
    el.style.left = "50%";
    el.style.bottom = "22px";
    el.style.transform = "translateX(-50%)";
    el.style.background = "rgba(18,26,51,.95)";
    el.style.border = "1px solid rgba(255,255,255,.15)";
    el.style.color = "white";
    el.style.padding = "10px 12px";
    el.style.borderRadius = "999px";
    el.style.boxShadow = "0 10px 30px rgba(0,0,0,.35)";
    el.style.zIndex = "999";
    el.style.fontSize = "13px";
    document.body.appendChild(el);
  }
  el.textContent = msg;
  el.style.opacity = "1";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ el.style.opacity = "0"; }, 1800);
}

/* ---------- Navigation ---------- */
function setView(name){
  $$(".tab").forEach(t=>t.setAttribute("aria-selected", String(t.dataset.view===name)));
  $$(".view").forEach(v=>v.hidden = true);
  $(`#view-${name}`).hidden = false;

  if (name==="home"){ renderHome(); renderLadder(); renderFinals(); }
  if (name==="teams"){ renderTeams(); attachTeamChipHandlers_(); }
  if (name==="fixtures"){ renderFixtures(); }
  if (name==="results"){ renderGate_(); if (isUnlocked_()){ populateRoundSelect(); populateMatchSelect(); } }
  if (name==="ladder"){ renderLadder(); renderFinals(); }
  if (name==="finals"){ renderFinals(); }
  if (name==="players"){ renderPlayerStats(); }
}

/* ---------- Init ---------- */
function init(){
  $$(".tab").forEach(btn=>btn.addEventListener("click", ()=>setView(btn.dataset.view)));

  $("#btnUnlock").addEventListener("click", tryUnlock_);
  $("#gateCode").addEventListener("keydown", (e)=>{ if (e.key === "Enter") tryUnlock_(); });
  $("#btnLock").addEventListener("click", lock_);

  $("#btnClearMatch").addEventListener("click", clearSelectedMatch);
  $("#btnResetAll").addEventListener("click", resetAllResults);

  populateRoundSelect();
  $("#roundSelect").addEventListener("change", ()=>{
    populateMatchSelect();
    $("#sheetHost").innerHTML = "";
  });
  $("#btnLoadSheet").addEventListener("click", ()=>{
    if (!isUnlocked_()){ toast_("Locked üîí"); return; }
    renderScoreSheet();
  });

  $("#btnGo").addEventListener("click", ()=>{
    const r = Number($("#roundJump").value);
    const el = document.getElementById(`round-${r}`);
    if (el) el.scrollIntoView({behavior:"smooth", block:"start"});
  });

  $("#btnPrint").addEventListener("click", ()=>window.print());

  updateUploadTab_();
  renderGate_();

  setCloudStatus_("Loading‚Ä¶", "warn", cloudReady_() ? "Reading from Google Sheets‚Ä¶" : "Paste your Web App URL into SHEETS_WEBAPP_URL");

  // Load from sheet
  (async ()=>{
    try{
      if (!cloudReady_()) throw new Error("Missing web app URL");
      RESULTS = await cloudDump_();
      setCloudStatus_("Connected", "good", "Live results loaded.");
    } catch (e){
      setCloudStatus_("Offline", "bad", e?.message || "Could not load from Sheets.");
    } finally {
      renderTeams();
      renderFixtures();
      renderLadder();
      renderFinals();
      renderPlayerStats();
      setView("home");
    }
  })();
}
init();
</script>
</body>
</html>
