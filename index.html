<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Berwick Tennis Club — Thursday Night Comp</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #f1f5f9;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --accent: #2563eb; /* Professional Blue */
      --accent-soft: #eff6ff;
      --border: #e2e8f0;
      --good: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --radius: 12px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    header {
      position: sticky; top: 0; z-index: 100;
      background: #ffffff;
      border-bottom: 2px solid var(--accent);
      box-shadow: var(--shadow);
    }

    .wrap { max-width: 1150px; margin: 0 auto; padding: 1rem; }
    
    .top { display: flex; flex-direction: column; gap: 1rem; }
    @media (min-width: 768px) {
      .top { flex-direction: row; justify-content: space-between; align-items: center; }
    }

    .brand h1 { font-size: 1.25rem; margin: 0; color: var(--accent); }
    .brand .sub { font-size: 0.85rem; color: var(--muted); margin-top: 2px; }

    nav { display: flex; gap: 0.5rem; overflow-x: auto; padding: 0.25rem 0; scrollbar-width: none; }
    nav::-webkit-scrollbar { display: none; }
    .tab {
      background: white; border: 1px solid var(--border); color: var(--muted);
      padding: 0.5rem 1rem; border-radius: 99px; cursor: pointer;
      font-size: 0.85rem; font-weight: 600; white-space: nowrap; transition: 0.2s;
    }
    .tab[aria-selected="true"] { background: var(--accent); color: white; border-color: var(--accent); }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; overflow: hidden; }
    .card-hd { padding: 1rem; border-bottom: 1px solid var(--border); background: #fafafa; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
    .card-bd { padding: 1rem; }
    .title { font-size: 1rem; margin: 0; font-weight: 700; }

    .grid { display: grid; gap: 1rem; }
    @media (min-width: 900px) { .grid.two { grid-template-columns: 1.2fr 0.8fr; } }

    .table-wrap { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; min-width: 500px; }
    th { text-align: left; padding: 0.75rem; font-size: 0.75rem; color: var(--muted); text-transform: uppercase; border-bottom: 2px solid var(--border); }
    td { padding: 0.75rem; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
    tr:last-child td { border-bottom: none; }
    .right { text-align: right; }
    .center { text-align: center; }

    .kpi { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
    @media (min-width: 768px) { .kpi { grid-template-columns: repeat(4, 1fr); } }
    .k { padding: 1rem; background: var(--accent-soft); border-radius: 10px; text-align: center; border: 1px solid #dbeafe; }
    .k .n { font-size: 1.25rem; font-weight: 800; color: var(--accent); }
    .k .l { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; margin-top: 4px; }

    .badge { padding: 0.25rem 0.6rem; border-radius: 99px; font-size: 0.75rem; font-weight: 600; background: #f1f5f9; color: var(--muted); border: 1px solid var(--border); }
    .badge.good { background: #dcfce7; color: #166534; border-color: #bbf7d0; }

    .team-chip { color: var(--accent); font-weight: 700; cursor: pointer; text-decoration: underline; text-decoration-color: #dbeafe; }
    
    .btn { padding: 0.6rem 1rem; border-radius: 8px; border: 1px solid var(--border); background: white; cursor: pointer; font-size: 0.85rem; font-weight: 600; }
    .btn.primary { background: var(--accent); color: white; border: none; }

    @media print { header, .tab, .btn { display: none !important; } }
  </style>
</head>

<body>
<header>
  <div class="wrap top">
    <div class="brand">
      <h1>Berwick Tennis Club</h1>
      <div class="sub">Thursday Night Comp • Autumn 2026</div>
    </div>
    <nav>
      <button class="tab" data-view="home" aria-selected="true">Home</button>
      <button class="tab" data-view="ladder">Ladder</button>
      <button class="tab" data-view="fixtures">Fixtures</button>
      <button class="tab" data-view="players">Players</button>
      <button class="tab" data-view="history">History</button>
      <button class="tab" data-view="rules">Rules</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <section id="view-home" class="view">
    <div class="grid two">
      <div class="card">
        <div class="card-hd"><h2 class="title">Next Round</h2><span id="nextRoundDate" class="badge"></span></div>
        <div class="card-bd" id="nextRoundMatches">Loading...</div>
      </div>
      <div class="card">
        <div class="card-hd"><h2 class="title">Quick Stats</h2></div>
        <div class="card-bd">
          <div class="kpi">
            <div class="k"><div class="n" id="kpiRoundsDone">0</div><div class="l">Rounds</div></div>
            <div class="k"><div class="n" id="kpiTopTeam">—</div><div class="l">Leader</div></div>
            <div class="k"><div class="n" id="kpiTopPlayer">—</div><div class="l">MVP</div></div>
            <div class="k"><div class="n" id="kpiMatchesDone">0</div><div class="l">Matches</div></div>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-hd"><h2 class="title">Latest Results</h2></div>
      <div class="card-bd table-wrap" id="latestResults"></div>
    </div>
  </section>

  <section id="view-ladder" class="view" hidden>
    <div class="card">
      <div class="card-hd"><h2 class="title">Competition Ladder</h2></div>
      <div class="card-bd table-wrap" id="ladderTable"></div>
    </div>
  </section>

  <section id="view-fixtures" class="view" hidden>
    <div class="card">
      <div class="card-hd"><h2 class="title">Fixtures</h2></div>
      <div class="card-bd" id="fixturesList"></div>
    </div>
  </section>

  <section id="view-players" class="view" hidden>
    <div class="card">
      <div class="card-hd"><h2 class="title">Player Rankings</h2></div>
      <div class="card-bd table-wrap" id="playerStatsTable"></div>
    </div>
  </section>

  <section id="view-history" class="view" hidden>
    <div class="card">
      <div class="card-hd">
        <h2 class="title">Match History</h2>
        <select id="historyTeamSelect" style="padding: 4px; border-radius: 4px;"></select>
      </div>
      <div class="card-bd">
        <div style="height: 300px; margin-bottom: 2rem;"><canvas id="historyChart"></canvas></div>
        <div class="table-wrap" id="historyTable"></div>
      </div>
    </div>
  </section>

  <section id="view-rules" class="view" hidden>
    <div class="card">
      <div class="card-hd"><h2 class="title">Competition Rules</h2></div>
      <div class="card-bd">
        <p>Berwick Tennis Club Thursday Night Format:</p>
        <ul>
          <li>Teams of 4 players (Ranked 1-4).</li>
          <li>6 doubles sets per night.</li>
          <li>First to 6 games wins the set (no tiebreak).</li>
          <li>Scoring: 1 point per set won + 2 bonus points for winning the night.</li>
        </ul>
      </div>
    </div>
  </section>
</main>

<script>
/* CONFIG */
const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbw8GVO1VqmhHyNhgoVr25lvkROu0D0lrqDA0RQqNQ0e3nxs8ZpJl_uXJe0XIvJjt-H1BQ/exec";
const READ_KEY = "BTC1818";

const teams = {
  1:{ name:"Team Cooper", players:["Cooper Khalil","Simran Chawla","David Sutton","Chris Maniatakis"] },
  2:{ name:"Team Enrique", players:["Enrique Lopez","Craig Kitner","Josh Bury","Varun Sridhara"] },
  3:{ name:"Team Michael", players:["Michael Rominger","David Ng","Cameron Rush","Alan Chumacero"] },
  4:{ name:"Team Jono", players:["Jonathan Rogers","Rafa Bouzinelos","David Thurmond","Andrew Watson"] },
  5:{ name:"Team Chung", players:["Chung Tan","Huss Shafai","Tom Maloney","Brett Kurz"] },
  6:{ name:"Team Vignesh", players:["Vignesh Pakkiam","Eric Castricum","Stephen Saunders","Mark Findlay"] },
  7:{ name:"Team Chris", players:["Chris Scott","Justin Hermann","Nick Teo","Dishit Devasia"] },
};

const rounds = [
  { r:1,  date:"05-Feb-26", matches:[[1,6],[2,5],[3,4],[7,null]] },
  { r:2,  date:"12-Feb-26", matches:[[4,2],[5,1],[6,7],[3,null]] },
  { r:3,  date:"19-Feb-26", matches:[[2,7],[3,6],[4,5],[1,null]] },
  { r:4,  date:"26-Feb-26", matches:[[5,3],[6,2],[7,1],[4,null]] },
  { r:5,  date:"05-Mar-26", matches:[[3,1],[4,7],[5,6],[2,null]] },
  { r:6,  date:"12-Mar-26", matches:[[6,4],[7,3],[1,2],[5,null]] },
  { r:7,  date:"19-Mar-26", matches:[[7,5],[1,4],[2,3],[6,null]] },
  { r:8,  date:"26-Mar-26", matches:[[1,6],[2,5],[3,4],[7,null]] },
  { r:9,  date:"23-Apr-26", matches:[[4,2],[5,1],[6,7],[3,null]] },
  { r:10, date:"30-Apr-26", matches:[[2,7],[3,6],[4,5],[1,null]] },
  { r:11, date:"07-May-26", matches:[[5,3],[6,2],[7,1],[4,null]] },
  { r:12, date:"14-May-26", matches:[[3,1],[4,7],[5,6],[2,null]] },
  { r:13, date:"21-May-26", matches:[[6,4],[7,3],[1,2],[5,null]] },
  { r:14, date:"28-May-26", matches:[[7,5],[1,4],[2,3],[6,null]] },
];

const pairings = [
  { key:"12", label:"1+2", a:[1,2], b:[1,2] },
  { key:"34", label:"3+4", a:[3,4], b:[3,4] },
  { key:"13", label:"1+3", a:[1,3], b:[1,3] },
  { key:"24", label:"2+4", a:[2,4], b:[2,4] },
  { key:"14", label:"1+4", a:[1,4], b:[1,4] },
  { key:"23", label:"2+3", a:[2,3], b:[2,3] },
];

/* STATE & LOGIC */
let RESULTS = {};
let historyChartInstance = null;

const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

async function cloudDump() {
  const url = `${SHEETS_WEBAPP_URL}?action=dump&key=${READ_KEY}`;
  const res = await fetch(url);
  const json = await res.json();
  return json.results || {};
}

function teamName(id) { return teams[id]?.name || `Team ${id}`; }

function buildLadder() {
  const base = {};
  Object.keys(teams).forEach(id => {
    base[id] = { id: Number(id), played: 0, points: 0, setsW: 0, setsL: 0, wins: 0 };
  });

  Object.values(RESULTS).forEach(m => {
    if (!m.a || !m.b) return;
    base[m.a].played++; base[m.b].played++;
    base[m.a].points += m.aPts; base[m.b].points += m.bPts;
    base[m.a].setsW += m.aSets; base[m.a].setsL += m.bSets;
    base[m.b].setsW += m.bSets; base[m.b].setsL += m.aSets;
    if (m.aSets > m.bSets) base[m.a].wins++;
    else if (m.bSets > m.aSets) base[m.b].wins++;
  });

  return Object.values(base).sort((a, b) => b.points - a.points || (b.setsW - b.setsL) - (a.setsW - a.setsL));
}

function renderHome() {
  const ladder = buildLadder();
  const next = rounds.find(r => r.matches.some(m => m[1] && !RESULTS[`r${r.r}_m${r.matches.indexOf(m)}`])) || rounds[rounds.length-1];
  
  $("#nextRoundDate").textContent = next.date;
  $("#nextRoundMatches").innerHTML = next.matches.map(m => `
    <div style="padding: 10px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
      <span>${teamName(m[0])} <small>vs</small> ${m[1] ? teamName(m[1]) : 'BYE'}</span>
      <span class="badge">${m[1] ? 'Scheduled' : '—'}</span>
    </div>
  `).join("");

  $("#kpiRoundsDone").textContent = new Set(Object.keys(RESULTS).map(k => k.split("_")[0])).size;
  $("#kpiTopTeam").textContent = ladder[0] ? `Team ${ladder[0].id}` : "—";
  $("#kpiMatchesDone").textContent = Object.keys(RESULTS).length;

  const latest = Object.entries(RESULTS).sort((a,b) => b[1].ts - a[1].ts).slice(0,5);
  $("#latestResults").innerHTML = `
    <table>
      <thead><tr><th>Match</th><th class="right">Sets</th><th class="right">Pts</th></tr></thead>
      <tbody>${latest.map(([id, m]) => `
        <tr>
          <td>${teamName(m.a)} vs ${teamName(m.b)}</td>
          <td class="right"><b>${m.aSets}–${m.bSets}</b></td>
          <td class="right">${m.aPts}–${m.bPts}</td>
        </tr>`).join("")}
      </tbody>
    </table>`;
}

function renderLadder() {
  const data = buildLadder();
  $("#ladderTable").innerHTML = `
    <table>
      <thead><tr><th>#</th><th>Team</th><th class="right">P</th><th class="right">Pts</th><th class="right">Sets W/L</th></tr></thead>
      <tbody>${data.map((r, i) => `
        <tr>
          <td>${i+1}</td>
          <td class="team-chip">Team ${r.id} (${teamName(r.id)})</td>
          <td class="right">${r.played}</td>
          <td class="right"><b>${r.points}</b></td>
          <td class="right">${r.setsW}–${r.setsL}</td>
        </tr>`).join("")}
      </tbody>
    </table>`;
}

function setView(view) {
  $$(".view").forEach(v => v.hidden = true);
  $$(".tab").forEach(t => t.setAttribute("aria-selected", t.dataset.view === view));
  $(`#view-${view}`).hidden = false;
  if (view === 'history') renderHistory();
}

function renderHistory() {
  const tid = Number($("#historyTeamSelect").value) || 1;
  const labels = rounds.map(r => `R${r.r}`);
  const pts = [];
  let cum = 0;
  
  rounds.forEach(r => {
    const m = Object.values(RESULTS).find(v => (v.a === tid || v.b === tid) && v.r === r.r);
    if (m) {
      const p = m.a === tid ? m.aPts : m.bPts;
      cum += p;
    }
    pts.push(cum);
  });

  if (historyChartInstance) historyChartInstance.destroy();
  historyChartInstance = new Chart($("#historyChart"), {
    type: 'line',
    data: { labels, datasets: [{ label: 'Total Points', data: pts, borderColor: '#2563eb', tension: 0.3 }] },
    options: { maintainAspectRatio: false }
  });
}

/* INIT */
(async () => {
  RESULTS = await cloudDump();
  
  const sel = $("#historyTeamSelect");
  Object.keys(teams).forEach(id => {
    const opt = document.createElement("option");
    opt.value = id; opt.textContent = teamName(id);
    sel.appendChild(opt);
  });
  sel.onchange = renderHistory;

  $$(".tab").forEach(t => t.onclick = () => setView(t.dataset.view));
  renderHome();
  renderLadder();
  
  // Fixtures and Players simple render
  $("#fixturesList").innerHTML = rounds.map(r => `
    <div style="margin-bottom:10px; padding:10px; background:white; border:1px solid var(--border); border-radius:8px;">
      <b>Round ${r.r} - ${r.date}</b><br>
      ${r.matches.map(m => `${teamName(m[0])} vs ${m[1] ? teamName(m[1]) : 'BYE'}`).join("<br>")}
    </div>
  `).join("");
})();
</script>
</body>
</html>
